---
title: "Analysis of COVID-era Apple Mobility Data"
author: "Nitish Bhargava"
date: "`r Sys.Date()`"
output:
bibliography: references.bib
params:
  state: "Utah"
  data: "data/raw_data/applemobilitytrends-2022-04-12.csv"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE)
```

## Setup 

```{r set-prameters}
# set the state to work with
state_to_analyze <- params$state

# sanitizing the state name for output files
state_no_spaces <- gsub(state_to_analyze, pattern = " ", replacement = "_")

# set the name of the global data file to use
global_file_to_process <- params$data
```

```{r load-in-packages-and-functions}
# load library
library("dplyr")
library("readr")
library("tidyr")
library("ggplot2")
library("lubridate")
library("devtools")
# Source Functions
source("code/functions/subset_mobility_data.R")
source("code/functions/make_data_longer.R")
source("code/functions/summarize_mobility_data.R")
```

# Background and Objectives

This report will use `dplyr` [@dplyr], `ggplot2` [@ggplot2], `readr` [@readr], and `tidyr` [@tidyr] to analyze apple maps mobility data from the time before the COVID pandemic through the initial shutdowns and the continuing changes over the course of the year. 

The goal will be to create a subset to a particular state, tally up the number of cities and counties in that state with mobility data, and then make several plots to visualize those data subsets.

The state that this document will analyze is `r state_to_analyze`.

```{r state-subset}
# subset out to the chosen state using the variable set above
state_subset <- subset_mobility_data(global_file_to_process, state_to_analyze)

```

```{r make-subset-long}
# convert the subsetted state data from wide to long
long_subset <- make_data_long(state_subset, state_to_analyze)
```

```{r summarize-data}
# summarize number of cities and counties in the state that have data
summarized_data <- summarize_mobility_data(state_no_spaces)
```

## Figures

```{r plot-type-and-number-of-areas}
# create a grouped bar plot of the tallied data to include in the knitted
# document, and save that figure to the output/figures directory as a png
summarized_plot <- ggplot(data = summarized_data,
                          aes(x = geo_type,
                              y = n,
                              fill = transportation_type)) +
  geom_col(position = position_dodge()) +
  labs(title = paste("Number of cities and/or counties in",
                     state_to_analyze,
                     "with mobility data"),
                     x = "Type of area",
                     y = "Number of Area")
ggsave(plot = summarized_plot,
       filename = paste0("output/applemobilitytrends-2022-04-12_",
                         state_no_spaces, "_summarized_plot.png"))

summarized_plot
```

```{r plot-time-series-driving}
# produce a line plot of relative driving mobility across the state with
# the date on the x axis and mean relative mobility on the y axis
timeseries_plot_driving <- long_subset %>%
  filter(transportation_type == "driving") %>%
  group_by(date) %>%
  summarize(mean_mobility = mean(value)) %>%
  ggplot(aes(x = lubridate::ymd(date),
             y = mean_mobility)) +
  geom_line() +
  labs(title = paste("Statewide mean relative mobility driving levels in",
                     state_to_analyze,
                     "during COVID"),
       x = "Date",
       y = "Mean relative mobility")

ggsave(plot = timeseries_plot_driving,
       filename = paste0("output/applemobilitytrends-2022-04-12_",
                         state_no_spaces,
                         "_timeseries_driving_plot.png"
                         ))

timeseries_plot_driving
```

```{r plot-time-series-walking}
# produce a line plot of relative walking mobility across the state with
# the date on the x axis and mean relative mobility on the y axis
timeseries_plot_walking <- long_subset %>%
  filter(transportation_type == "walking") %>%
  group_by(date) %>%
  summarize(mean_mobility = mean(value)) %>%
  ggplot(aes(x = lubridate::ymd(date),
             y = mean_mobility)) +
  geom_line() +
  labs(title = paste("Statewide mean relative mobility walking levels in",
                     state_to_analyze,
                     "during COVID"),
       x = "Date",
       y = "Mean relative mobility")

ggsave(plot = timeseries_plot_walking,
       filename = paste0("output/applemobilitytrends-2022-04-12_",
                         state_no_spaces,
                         "_timeseries_walking_plot.png"
                         ))

timeseries_plot_walking

```

```{r plot-sequence-data, fig.height=12}
# read in the count of the sequences by country (2 columns)
seqs_by_country <- readr::read_table(params$seqdata,
				     col_names = c("count",
						   "country"))
# check that we have the right number of columns
stopifnot(ncol(seqs_by_country) == 2)

# make a sideways barplot, log scale x axis, with countries on the y
# and the counts of sequences in each on the x, sorted by count
seq_count_plot <- ggplot(data = seqs_by_country,
				aes(x = count,
				    y = reorder(country, count))) +
 geom_col() +
 scale_x_log10() +
 labs(title = "Count of SARS-CoV-2 sequeces per country",
      x = "Count of Sequences",
      y = "Country Name")

ggsave(plot = seq_count_plot,
	filename = "output/figures/seq_count_plot.png")

seq_count_plot
```

## Session Info

```{r session-info}
devtools::session_info()
```



# Sources Cited
